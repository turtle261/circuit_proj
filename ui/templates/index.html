<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit AI - Design Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        .progress-container {
            display: none;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .progress-container:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .stage-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stage {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 0 5px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .stage.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        .stage.completed {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(1.02);
        }
        .stage.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .results-section {
            display: none;
        }
        .plot-container {
            height: 400px;
            margin: 20px 0;
        }
        .schematic-container {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .component-list {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .example-buttons {
            margin: 15px 0;
        }
        .example-btn {
            margin: 5px;
        }
    </style>
</head>
<body>
    <!-- Status Indicator -->
    <div id="statusIndicator" class="status-indicator">
        <div class="alert alert-info" style="display: none;">
            <i class="fas fa-wifi"></i> <span id="connectionStatus">Connecting...</span>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center mb-3">
                    <i class="fas fa-microchip text-primary"></i>
                    Circuit AI Design Assistant
                </h1>
                <p class="text-center text-muted">
                    AI-powered circuit design and simulation for Arduino projects
                </p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-edit text-primary"></i>
                            Describe Your Circuit
                        </h5>
                        
                        <!-- Example Buttons -->
                        <div class="example-buttons">
                            <p class="text-muted mb-2">Try these examples:</p>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-primary">LED Circuits</h6>
                                    <button class="btn btn-outline-primary btn-sm example-btn mb-1" 
                                            onclick="setExample('Design a circuit to blink an LED every second')">
                                        LED Blinker
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm example-btn mb-1" 
                                            onclick="setExample('Create a circuit with an LED that turns on when a button is pressed')">
                                        Button LED
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm example-btn mb-1" 
                                            onclick="setExample('Design a circuit with a red LED that has brightness inverse to room loudness')">
                                        Sound-Reactive LED
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-success">Motor Control</h6>
                                    <button class="btn btn-outline-success btn-sm example-btn mb-1" 
                                            onclick="setExample('Design a motor control circuit with variable speed')">
                                        Variable Speed Motor
                                    </button>
                                    <button class="btn btn-outline-success btn-sm example-btn mb-1" 
                                            onclick="setExample('Create a servo motor control circuit for precise positioning')">
                                        Servo Control
                                    </button>
                                    <button class="btn btn-outline-success btn-sm example-btn mb-1" 
                                            onclick="setExample('Design a stepper motor driver circuit')">
                                        Stepper Motor
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-warning">Sensors</h6>
                                    <button class="btn btn-outline-warning btn-sm example-btn mb-1" 
                                            onclick="setExample('Design a temperature sensor circuit with LCD display')">
                                        Temperature Sensor
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm example-btn mb-1" 
                                            onclick="setExample('Create a light sensor circuit that controls LED brightness')">
                                        Light Sensor
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm example-btn mb-1" 
                                            onclick="setExample('Design an ultrasonic distance sensor circuit')">
                                        Distance Sensor
                                    </button>
                                </div>
                            </div>
                        </div>

                        <form id="designForm">
                            <div class="mb-3">
                                <textarea class="form-control" id="circuitDescription" rows="4" 
                                    placeholder="e.g., Design a circuit to blink an LED every second with adjustable brightness"></textarea>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-primary" onclick="testSimulation()">
                                    <i class="fas fa-flask"></i> Test Simulation
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-magic"></i> Generate Design
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="row progress-container" id="progressContainer">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cogs text-primary"></i>
                            Design Progress
                        </h5>
                        
                        <!-- Stage Indicators -->
                        <div class="stage-indicator">
                            <div class="stage" id="stage-research">
                                <i class="fas fa-search"></i><br>
                                Research
                            </div>
                            <div class="stage" id="stage-design">
                                <i class="fas fa-drafting-compass"></i><br>
                                Design
                            </div>
                            <div class="stage" id="stage-simulation">
                                <i class="fas fa-calculator"></i><br>
                                Simulation
                            </div>
                            <div class="stage" id="stage-schematic">
                                <i class="fas fa-project-diagram"></i><br>
                                Schematic
                            </div>
                            <div class="stage" id="stage-pcb">
                                <i class="fas fa-microchip"></i><br>
                                PCB Layout
                            </div>
                            <div class="stage" id="stage-complete">
                                <i class="fas fa-check"></i><br>
                                Complete
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>

                        <!-- Status Message -->
                        <div class="text-center">
                            <p id="progressMessage" class="mb-0">Starting design process...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row results-section" id="resultsSection">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line text-success"></i>
                            Design Results
                        </h5>

                        <!-- Tabs for different result types -->
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                        data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-info-circle"></i> Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="schematic-tab" data-bs-toggle="tab" 
                                        data-bs-target="#schematic" type="button" role="tab">
                                    <i class="fas fa-project-diagram"></i> Schematic
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="simulation-tab" data-bs-toggle="tab" 
                                        data-bs-target="#simulation" type="button" role="tab">
                                    <i class="fas fa-chart-area"></i> Simulation
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="code-tab" data-bs-toggle="tab" 
                                        data-bs-target="#code" type="button" role="tab">
                                    <i class="fas fa-code"></i> Arduino Code
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pcb-tab" data-bs-toggle="tab" 
                                        data-bs-target="#pcb" type="button" role="tab">
                                    <i class="fas fa-microchip"></i> PCB Layout
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="resultTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="mt-3">
                                    <div id="designOverview"></div>
                                    <div id="componentList" class="component-list"></div>
                                </div>
                            </div>

                            <!-- Schematic Tab -->
                            <div class="tab-pane fade" id="schematic" role="tabpanel">
                                <div class="schematic-container mt-3">
                                    <div id="schematicDisplay">
                                        <p class="text-muted">Schematic will appear here...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Simulation Tab -->
                            <div class="tab-pane fade" id="simulation" role="tabpanel">
                                <div class="mt-3">
                                    <div id="simulationPlots"></div>
                                    <div id="simulationData"></div>
                                </div>
                            </div>

                            <!-- Code Tab -->
                            <div class="tab-pane fade" id="code" role="tabpanel">
                                <div class="mt-3">
                                    <div id="arduinoCode"></div>
                                </div>
                            </div>

                            <!-- PCB Layout Tab -->
                            <div class="tab-pane fade" id="pcb" role="tabpanel">
                                <div class="mt-3">
                                    <div id="pcbLayoutDisplay">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div id="pcbVisualization">
                                                    <p class="text-muted">PCB layout will appear here...</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div id="pcbInfo">
                                                    <h6>PCB Information</h6>
                                                    <div id="pcbStats"></div>
                                                    <div id="manufacturingFiles" class="mt-3"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Download Section -->
                        <div class="mt-4 text-center" id="downloadSection" style="display: none;">
                            <h6>Download Files</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="downloadFile('schematic')">
                                    <i class="fas fa-download"></i> Schematic
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="downloadFile('code')">
                                    <i class="fas fa-download"></i> Arduino Code
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="downloadFile('report')">
                                    <i class="fas fa-download"></i> Full Report
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="downloadFile('pcb')">
                                    <i class="fas fa-download"></i> PCB Files
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Socket.IO
        const socket = io();
        let currentResults = {};

        // Connection status
        socket.on('connect', function() {
            console.log('WebSocket connected');
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.querySelector('#statusIndicator .alert').className = 'alert alert-success';
            document.querySelector('#statusIndicator .alert').style.display = 'block';
            setTimeout(() => {
                document.querySelector('#statusIndicator .alert').style.display = 'none';
            }, 3000);
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.querySelector('#statusIndicator .alert').className = 'alert alert-danger';
            document.querySelector('#statusIndicator .alert').style.display = 'block';
        });

        // Design progress updates
        socket.on('design_progress', function(data) {
            console.log('Received design_progress:', data);
            updateProgress(data.stage, data.message, data.progress, data.detail);
        });

        socket.on('design_complete', function(data) {
            console.log('Received design_complete:', data);
            currentResults = data;
            showResults(data);
        });

        socket.on('design_error', function(data) {
            console.log('Received design_error:', data);
            showError(data.error);
        });

        socket.on('simulation_complete', function(data) {
            displaySimulationResults(data);
        });

        // Form submission
        document.getElementById('designForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const description = document.getElementById('circuitDescription').value.trim();
            
            if (!description) {
                alert('Please enter a circuit description');
                return;
            }

            startDesignProcess(description);
        });

        function setExample(text) {
            document.getElementById('circuitDescription').value = text;
        }

        function startDesignProcess(description) {
            // Show progress container
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Reset progress
            resetProgress();
            
            // Send design request
            fetch('/design', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({description: description})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    showError(data.message);
                }
            })
            .catch(error => {
                showError('Network error: ' + error.message);
            });
        }

        function updateProgress(stage, message, progress, detail) {
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            
            // Update main message
            document.getElementById('progressMessage').textContent = message;
            
            // Update detail message if provided
            if (detail) {
                let detailElement = document.getElementById('progressDetail');
                if (!detailElement) {
                    // Create detail element if it doesn't exist
                    detailElement = document.createElement('div');
                    detailElement.id = 'progressDetail';
                    detailElement.className = 'text-muted small mt-1';
                    document.getElementById('progressMessage').parentNode.appendChild(detailElement);
                }
                detailElement.textContent = detail;
                detailElement.style.display = 'block';
            }
            
            // Update stage indicators
            const stages = ['research', 'design', 'simulation', 'schematic', 'pcb', 'complete'];
            const currentIndex = stages.indexOf(stage);
            
            stages.forEach((stageName, index) => {
                const stageElement = document.getElementById('stage-' + stageName);
                if (index < currentIndex) {
                    stageElement.className = 'stage completed';
                } else if (index === currentIndex) {
                    stageElement.className = 'stage active';
                } else {
                    stageElement.className = 'stage';
                }
            });
            
            // Add visual feedback with animation
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.transform = 'scale(1.02)';
            setTimeout(() => {
                progressContainer.style.transform = 'scale(1)';
            }, 200);
        }

        function resetProgress() {
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressMessage').textContent = 'Starting design process...';
            
            // Clear detail element if it exists
            const detailElement = document.getElementById('progressDetail');
            if (detailElement) {
                detailElement.style.display = 'none';
                detailElement.textContent = '';
            }
            
            const stages = ['research', 'design', 'simulation', 'schematic', 'complete'];
            stages.forEach(stage => {
                document.getElementById('stage-' + stage).className = 'stage';
            });
        }

        function showResults(data) {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Display overview
            displayOverview(data);
            
            // Display schematic
            if (data.schematic) {
                displaySchematic(data.schematic);
            }
            
            // Display simulation results
            if (data.simulation) {
                displaySimulationResults(data);
            }
            
            // Display Arduino code
            displayArduinoCode(data);
            
            // Display PCB layout
            if (data.pcb) {
                displayPCBLayout(data.pcb);
            }
            
            // Show download section
            document.getElementById('downloadSection').style.display = 'block';
        }

        function displayOverview(data) {
            const overview = document.getElementById('designOverview');
            
            // Extract circuit type and description from crew result
            let circuitDescription = "Your circuit has been successfully designed and simulated!";
            let circuitType = data.circuit_type || "custom";
            
            // Generate circuit-specific descriptions
            if (circuitType === 'led') {
                circuitDescription = "This project details the construction and testing of an LED circuit. The circuit is designed to control LED brightness and blinking patterns using an Arduino microcontroller with current-limiting resistors for safe operation.";
            } else if (circuitType === 'motor') {
                circuitDescription = "This project details the construction and testing of a motor control circuit. The circuit is designed to control motor speed and direction using PWM signals from an Arduino with appropriate driver circuits for power management.";
            } else if (circuitType === 'sensor') {
                circuitDescription = "This project details the construction and testing of a sensor interface circuit. The circuit is designed to read analog sensor values and process them through an Arduino with signal conditioning and filtering.";
            } else if (data.crew_result && typeof data.crew_result === 'string') {
                // Try to extract project description from CrewAI result
                const descMatch = data.crew_result.match(/## 1\. Project Overview\s*([\s\S]*?)##/);
                if (descMatch) {
                    const desc = descMatch[1].trim().split('\n')[0];
                    if (desc.length > 10) {
                        circuitDescription = desc;
                    }
                }
            }
            
            // Determine status message
            let statusMessage = "Design completed successfully with CrewAI agents and simulation validation.";
            if (data.phase_2_1_enabled && data.phase_2_2_enabled) {
                statusMessage = "Design completed successfully with CrewAI agents, Phase 2.1 advanced simulation, and Phase 2.2 PCB layout generation.";
            } else if (data.phase_2_1_enabled) {
                statusMessage = "Design completed successfully with CrewAI agents and Phase 2.1 advanced simulation validation.";
            } else if (data.phase_2_2_enabled) {
                statusMessage = "Design completed successfully with CrewAI agents, simulation validation, and Phase 2.2 PCB layout generation.";
            }
            
            overview.innerHTML = `
                <h6>Design Summary</h6>
                <p>${circuitDescription}</p>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    ${statusMessage}
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Circuit Type:</strong> ${circuitType.toUpperCase()}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong> <span class="text-success">Complete</span>
                    </div>
                </div>
                ${data.phase_2_1_enabled ? `
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-microchip"></i>
                            <strong>Phase 2.1 Features:</strong> Advanced simulation with AC analysis, noise analysis, Monte Carlo, and temperature analysis enabled.
                        </div>
                    </div>
                </div>
                ` : ''}
                ${data.phase_2_2_enabled ? `
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="alert alert-success">
                            <i class="fas fa-microchip"></i>
                            <strong>Phase 2.2 Features:</strong> Professional PCB layout generation with manufacturing files (Gerber, drill, pick & place, BOM) enabled.
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Display component list if available
            const componentList = document.getElementById('componentList');
            let componentsHtml = '<h6>Components Used</h6><ul class="list-group list-group-flush">';
            
            // Add Arduino
            componentsHtml += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Arduino Uno R3
                    <span class="badge bg-primary rounded-pill"><i class="fas fa-info-circle" title="Microcontroller board"></i></span>
                </li>
            `;
            
            // Add components based on circuit type and data
            if (data.components && (data.components.resistor || data.components.led)) {
                if (data.components.resistor) {
                    const resistor = data.components.resistor.component || data.components.resistor;
                    componentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${resistor.name || resistor.value + 'Ω Resistor'}
                            <span class="badge bg-secondary rounded-pill">1</span>
                        </li>
                    `;
                }
                if (data.components.led) {
                    const led = data.components.led.component || data.components.led;
                    componentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${led.name || led.color + ' LED'}
                            <span class="badge bg-danger rounded-pill">1</span>
                        </li>
                    `;
                }
            } else {
                // Circuit-type specific default components
                if (circuitType === 'led') {
                    componentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            330Ω Resistor (1/4W, Metal Film)
                            <span class="badge bg-secondary rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Red LED (5mm, 2V forward voltage)
                            <span class="badge bg-danger rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Breadboard
                            <span class="badge bg-success rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Jumper Wires
                            <span class="badge bg-warning rounded-pill">3</span>
                        </li>
                    `;
                } else if (circuitType === 'motor') {
                    componentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            L298N Motor Driver
                            <span class="badge bg-info rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            DC Motor (6V)
                            <span class="badge bg-dark rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            10kΩ Potentiometer
                            <span class="badge bg-secondary rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Power Supply (9V)
                            <span class="badge bg-warning rounded-pill">1</span>
                        </li>
                    `;
                } else if (circuitType === 'sensor') {
                    componentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Analog Sensor (Temperature/Light)
                            <span class="badge bg-info rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            10kΩ Pull-up Resistor
                            <span class="badge bg-secondary rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            330Ω LED Resistor
                            <span class="badge bg-secondary rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Status LED
                            <span class="badge bg-danger rounded-pill">1</span>
                        </li>
                    `;
                } else {
                    componentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            220Ω Resistor (1/4W)
                            <span class="badge bg-secondary rounded-pill">1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Red LED (5mm)
                            <span class="badge bg-danger rounded-pill">1</span>
                        </li>
                    `;
                }
            }
            
            componentsHtml += '</ul>';
            componentList.innerHTML = componentsHtml;
        }

        function displaySchematic(schematicData) {
            const schematicDisplay = document.getElementById('schematicDisplay');
            const circuitType = currentResults.circuit_type || 'led';
            
            if (schematicData && schematicData.svg_file) {
                // If we have an SVG file, display it
                const svgFile = schematicData.svg_file;
                schematicDisplay.innerHTML = `
                    <h6>Circuit Schematic</h6>
                    <div class="text-center">
                        <embed src="/view/${svgFile}" type="image/svg+xml" width="100%" height="300">
                    </div>
                `;
            } else {
                // Circuit-type specific fallback descriptions
                let description = "Circuit schematic with components connected to Arduino.";
                let svgPath = "led_circuit.svg";
                
                if (circuitType === 'led') {
                    description = "LED circuit with current limiting resistor connected to Arduino pin D13.";
                    svgPath = "led_circuit.svg";
                } else if (circuitType === 'motor') {
                    description = "Motor control circuit with L298N driver connected to Arduino PWM pins.";
                    svgPath = "motor_circuit.svg";
                } else if (circuitType === 'sensor') {
                    description = "Sensor interface circuit with analog input and status LED connected to Arduino.";
                    svgPath = "sensor_circuit.svg";
                }
                
                schematicDisplay.innerHTML = `
                    <h6>Circuit Schematic</h6>
                    <div class="text-center">
                        <embed src="/view/${svgPath}" type="image/svg+xml" width="100%" height="300" 
                               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none;" class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <p>${description}</p>
                            <p>Schematic files have been generated and are available for download.</p>
                        </div>
                    </div>
                `;
            }
        }

        function displaySimulationResults(data) {
            const simulationPlots = document.getElementById('simulationPlots');
            const simulationData = document.getElementById('simulationData');
            
            // Display plots if available
            if (data.plot_data) {
                simulationPlots.innerHTML = '<div id="plotDiv" class="plot-container"></div>';
                
                // Create plot from base64 data
                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + data.plot_data;
                img.style.width = '100%';
                img.style.height = 'auto';
                document.getElementById('plotDiv').appendChild(img);
            } else {
                simulationPlots.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-chart-line"></i>
                        Simulation plots will be displayed here when available. Phase 2.1 supports AC analysis, Bode plots, noise analysis, and Monte Carlo simulations.
                    </div>
                `;
            }
            
            // Display simulation data
            if (data.simulation || data.results) {
                const simData = data.simulation || data.results;
                const isPhase21 = data.phase_2_1_enabled;
                
                let analysisCards = '';
                
                // DC Analysis Card
                analysisCards += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-battery-half"></i> DC Analysis
                                </h6>
                                <p class="card-text">
                                    Analysis Type: ${simData.analysis_type || 'DC Operating Point'}<br>
                                    Status: <span class="${simData.success ? 'text-success' : 'text-danger'}">${simData.success ? 'Success' : 'Failed'}</span><br>
                                    Circuit Type: ${simData.circuit_type || 'Unknown'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Performance Card
                analysisCards += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-tachometer-alt"></i> Performance
                                </h6>
                                <p class="card-text">
                                    Circuit validated and ready for implementation.<br>
                                    ${isPhase21 ? 'Advanced Phase 2.1 analysis completed.' : 'Basic analysis completed.'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Phase 2.1 specific analysis cards
                if (isPhase21) {
                    analysisCards += `
                        <div class="col-md-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-wave-square"></i> AC Analysis
                                    </h6>
                                    <p class="card-text">
                                        Frequency response analysis<br>
                                        Bode plots for magnitude and phase<br>
                                        <small class="text-muted">Phase 2.1 Feature</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-volume-down"></i> Noise Analysis
                                    </h6>
                                    <p class="card-text">
                                        Input-referred noise density<br>
                                        SNR across frequency range<br>
                                        <small class="text-muted">Phase 2.1 Feature</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-dice"></i> Monte Carlo
                                    </h6>
                                    <p class="card-text">
                                        Component tolerance analysis<br>
                                        Statistical performance distribution<br>
                                        <small class="text-muted">Phase 2.1 Feature</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-thermometer-half"></i> Temperature
                                    </h6>
                                    <p class="card-text">
                                        Performance across temperature range<br>
                                        -40°C to +85°C analysis<br>
                                        <small class="text-muted">Phase 2.1 Feature</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                simulationData.innerHTML = `
                    <h6>Simulation Results</h6>
                    <div class="row">
                        ${analysisCards}
                    </div>
                `;
            } else {
                simulationData.innerHTML = `
                    <h6>Simulation Results</h6>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        No simulation data available. The circuit design was completed but simulation results were not generated.
                    </div>
                `;
            }
        }

        function displayArduinoCode(crewResult) {
            const codeDisplay = document.getElementById('arduinoCode');
            const circuitType = currentResults.circuit_type || 'led';
            
            // Default circuit-type specific code
            let code = '';
            
            if (circuitType === 'led') {
                code = `// Arduino LED Control Code
// Generated by Circuit AI

#define LED_PIN 13

void setup() {
  pinMode(LED_PIN, OUTPUT);
  Serial.begin(9600);
  Serial.println("LED Circuit Ready");
}

void loop() {
  digitalWrite(LED_PIN, HIGH);  // Turn LED on
  delay(1000);                  // Wait 1 second
  digitalWrite(LED_PIN, LOW);   // Turn LED off
  delay(1000);                  // Wait 1 second
}`;
            } else if (circuitType === 'motor') {
                code = `// Arduino Motor Control Code
// Generated by Circuit AI

#define MOTOR_PIN1 9
#define MOTOR_PIN2 10
#define SPEED_PIN 6

void setup() {
  pinMode(MOTOR_PIN1, OUTPUT);
  pinMode(MOTOR_PIN2, OUTPUT);
  pinMode(SPEED_PIN, OUTPUT);
  Serial.begin(9600);
  Serial.println("Motor Control Ready");
}

void loop() {
  // Forward direction
  digitalWrite(MOTOR_PIN1, HIGH);
  digitalWrite(MOTOR_PIN2, LOW);
  analogWrite(SPEED_PIN, 150);  // 60% speed
  delay(2000);
  
  // Stop
  analogWrite(SPEED_PIN, 0);
  delay(1000);
  
  // Reverse direction
  digitalWrite(MOTOR_PIN1, LOW);
  digitalWrite(MOTOR_PIN2, HIGH);
  analogWrite(SPEED_PIN, 100);  // 40% speed
  delay(2000);
  
  // Stop
  analogWrite(SPEED_PIN, 0);
  delay(1000);
}`;
            } else if (circuitType === 'sensor') {
                code = `// Arduino Sensor Reading Code
// Generated by Circuit AI

#define SENSOR_PIN A0
#define LED_PIN 13
#define THRESHOLD 512

void setup() {
  pinMode(LED_PIN, OUTPUT);
  Serial.begin(9600);
  Serial.println("Sensor Circuit Ready");
}

void loop() {
  int sensorValue = analogRead(SENSOR_PIN);
  float voltage = sensorValue * (5.0 / 1023.0);
  
  Serial.print("Sensor Value: ");
  Serial.print(sensorValue);
  Serial.print(" | Voltage: ");
  Serial.println(voltage);
  
  // Turn on LED if sensor value exceeds threshold
  if (sensorValue > THRESHOLD) {
    digitalWrite(LED_PIN, HIGH);
  } else {
    digitalWrite(LED_PIN, LOW);
  }
  
  delay(500);
}`;
            } else {
                code = `// Arduino Custom Circuit Code
// Generated by Circuit AI

#define OUTPUT_PIN 13

void setup() {
  pinMode(OUTPUT_PIN, OUTPUT);
  Serial.begin(9600);
  Serial.println("Custom Circuit Ready");
}

void loop() {
  digitalWrite(OUTPUT_PIN, HIGH);
  delay(1000);
  digitalWrite(OUTPUT_PIN, LOW);
  delay(1000);
}`;
            }
            
            // Try to extract Arduino code from CrewAI result if available
            if (crewResult && typeof crewResult === 'string') {
                // Look for code blocks in the crew result
                const codeBlockRegex = /```(?:cpp|c\+\+|arduino)?\s*([\s\S]*?)```/gi;
                const matches = crewResult.match(codeBlockRegex);
                
                if (matches && matches.length > 0) {
                    // Use the first code block found
                    const extractedCode = matches[0].replace(/```(?:cpp|c\+\+|arduino)?\s*/, '').replace(/```$/, '').trim();
                    if (extractedCode.length > 50) { // Only use if it's substantial code
                        code = extractedCode;
                    }
                } else {
                    // Look for code between specific markers
                    const markerRegex = /\/\/ main_code\.ino([\s\S]*?)\/\/----------------------------------------------------------------------------------------------------------------------/gi;
                    const markerMatch = crewResult.match(markerRegex);
                    
                    if (markerMatch && markerMatch.length > 0) {
                        const extractedCode = markerMatch[0].replace(/\/\/ main_code\.ino\s*/, '').replace(/\/\/----------------------------------------------------------------------------------------------------------------------.*$/, '').trim();
                        if (extractedCode.length > 50) {
                            code = extractedCode;
                        }
                    } else {
                        // Look for any Arduino-style code patterns
                        const arduinoRegex = /(#define.*?[\s\S]*?void\s+setup\s*\(\s*\)\s*\{[\s\S]*?\}[\s\S]*?void\s+loop\s*\(\s*\)\s*\{[\s\S]*?\})/gi;
                        const arduinoMatch = crewResult.match(arduinoRegex);
                        
                        if (arduinoMatch && arduinoMatch.length > 0) {
                            const extractedCode = arduinoMatch[0].trim();
                            if (extractedCode.length > 50) {
                                code = extractedCode;
                            }
                        }
                    }
                }
            }
            
            codeDisplay.innerHTML = `
                <h6>Arduino Code</h6>
                <div class="card">
                    <div class="card-body">
                        <pre><code>${code}</code></pre>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Upload Instructions</h6>
                    <ol>
                        <li>Connect your Arduino to your computer via USB</li>
                        <li>Open the Arduino IDE</li>
                        <li>Copy and paste the code above</li>
                        <li>Select your board and port in Tools menu</li>
                        <li>Click Upload button</li>
                    </ol>
                </div>
            `;
        }

        function displayPCBLayout(pcbData) {
            console.log('Displaying PCB layout:', pcbData);
            
            const pcbVisualization = document.getElementById('pcbVisualization');
            const pcbStats = document.getElementById('pcbStats');
            const manufacturingFiles = document.getElementById('manufacturingFiles');

            if (pcbData.status === 'generated') {
                // Update PCB visualization area
                pcbVisualization.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        PCB layout generated successfully with manufacturing files
                    </div>
                    <div class="border rounded p-3 mb-3" style="min-height: 300px; background: #f8f9fa;">
                        <div class="text-center">
                            <i class="fas fa-microchip fa-3x text-primary mb-3"></i>
                            <h5>PCB Layout Preview</h5>
                            <p class="text-muted">Professional PCB layout with optimized routing</p>
                            <div class="pcb-info">
                                <small class="text-muted">
                                    <strong>Board Size:</strong> ${pcbData.layout_result ? JSON.parse(pcbData.layout_result).board_size || '80x60mm' : '80x60mm'}<br>
                                    <strong>Layers:</strong> ${pcbData.layout_result ? JSON.parse(pcbData.layout_result).layer_count || '2' : '2'}-layer PCB<br>
                                    <strong>Technology:</strong> Through-hole and SMD compatible
                                </small>
                            </div>
                        </div>
                    </div>
                `;

                // Update PCB stats
                if (pcbData.layout_result) {
                    try {
                        const layoutData = JSON.parse(pcbData.layout_result);
                        pcbStats.innerHTML = `
                            <div class="row">
                                <div class="col-12">
                                    <strong>Project:</strong> ${layoutData.project_name || 'Circuit'}<br>
                                    <strong>Board Size:</strong> ${layoutData.board_size || 'N/A'}<br>
                                    <strong>Components:</strong> ${layoutData.component_count || 'N/A'}<br>
                                    <strong>DRC Status:</strong> <span class="text-success">${layoutData.drc_status || 'PASS'}</span><br>
                                    <strong>Cost:</strong> ${layoutData.total_cost || 'N/A'}
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error parsing PCB layout result:', e);
                        pcbStats.innerHTML = `
                            <div class="text-muted">
                                PCB specifications available in manufacturing files
                            </div>
                        `;
                    }
                } else {
                    pcbStats.innerHTML = `
                        <div class="text-muted">
                            PCB specifications available in manufacturing files
                        </div>
                    `;
                }

                // Update manufacturing files
                manufacturingFiles.innerHTML = `
                    <h6><i class="fas fa-industry"></i> Manufacturing Files</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-file-alt text-success"></i> Gerber files (.gbr)</li>
                        <li><i class="fas fa-file-alt text-success"></i> Drill files (.drl)</li>
                        <li><i class="fas fa-file-alt text-success"></i> Pick & place (.csv)</li>
                        <li><i class="fas fa-file-alt text-success"></i> Bill of materials (.json)</li>
                    </ul>
                    <div class="mt-3">
                        <small class="text-muted">
                            Ready for professional PCB manufacturing
                        </small>
                    </div>
                `;
            } else if (pcbData.status === 'failed') {
                pcbVisualization.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        PCB layout generation failed: ${pcbData.error || 'Unknown error'}
                    </div>
                    <p class="text-muted">The circuit design is complete, but PCB layout could not be generated. You can still use the schematic and Arduino code.</p>
                `;
                pcbStats.innerHTML = '';
                manufacturingFiles.innerHTML = '';
            } else {
                pcbVisualization.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        PCB layout generation not available
                    </div>
                    <p class="text-muted">Phase 2.2 PCB layout tools are not currently loaded. The circuit design and simulation are complete.</p>
                `;
                pcbStats.innerHTML = '';
                manufacturingFiles.innerHTML = '';
            }
        }

        function testSimulation() {
            socket.emit('test_simulation');
        }

        function downloadFile(type) {
            if (!currentResults) {
                alert('No design results available. Please generate a circuit first.');
                return;
            }

            const projectName = currentResults.circuit_type || 'circuit';
            
            switch(type) {
                case 'schematic':
                    if (currentResults.schematic && currentResults.schematic.svg_file) {
                        window.open(`/download/${currentResults.schematic.svg_file}`, '_blank');
                    } else {
                        alert('Schematic file not available.');
                    }
                    break;
                    
                case 'code':
                    if (currentResults.arduino_code) {
                        // Create a downloadable Arduino file
                        const arduinoCode = currentResults.arduino_code;
                        const blob = new Blob([arduinoCode], { type: 'text/plain' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${projectName}.ino`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        alert('Arduino code not available.');
                    }
                    break;
                    
                case 'report':
                    // Generate a comprehensive report
                    const reportContent = generateFullReport(currentResults);
                    const blob = new Blob([reportContent], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${projectName}_report.txt`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    break;
                    
                case 'pcb':
                    if (currentResults.pcb && currentResults.pcb.status === 'generated') {
                        // Download the BOM file as an example
                        window.open(`/download/${projectName}_bom.json`, '_blank');
                        alert('PCB manufacturing files are available in the output directory:\n\n• Gerber files (.gbr)\n• Drill files (.drl)\n• Pick & place files (.csv)\n• Bill of materials (.json)\n• Assembly drawings (.txt)');
                    } else {
                        alert('PCB files are not available. Please ensure PCB layout was generated successfully.');
                    }
                    break;
                    
                default:
                    alert(`Download functionality for ${type} files not implemented.`);
            }
        }

        function generateFullReport(results) {
            let report = `Circuit Design Report\n`;
            report += `=====================\n\n`;
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Circuit Type: ${results.circuit_type || 'Custom'}\n\n`;
            
            if (results.crew_result) {
                report += `Design Analysis:\n`;
                report += `${results.crew_result}\n\n`;
            }
            
            if (results.simulation && results.simulation.results) {
                report += `Simulation Results:\n`;
                report += `Analysis Type: ${results.simulation.results.analysis_type}\n`;
                if (results.simulation.results.nodes) {
                    report += `Node Voltages:\n`;
                    for (const [node, voltage] of Object.entries(results.simulation.results.nodes)) {
                        report += `  ${node}: ${voltage}V\n`;
                    }
                }
                if (results.simulation.results.currents) {
                    report += `Currents:\n`;
                    for (const [component, current] of Object.entries(results.simulation.results.currents)) {
                        report += `  ${component}: ${current}A\n`;
                    }
                }
                report += `\n`;
            }
            
            if (results.pcb && results.pcb.layout_result) {
                try {
                    const pcbData = JSON.parse(results.pcb.layout_result);
                    report += `PCB Layout Information:\n`;
                    report += `Board Size: ${pcbData.board_size}\n`;
                    report += `Layer Count: ${pcbData.layer_count}\n`;
                    report += `Component Count: ${pcbData.component_count}\n`;
                    report += `DRC Status: ${pcbData.drc_status}\n`;
                    report += `Total Cost: ${pcbData.total_cost}\n\n`;
                } catch (e) {
                    report += `PCB Layout: Generated successfully\n\n`;
                }
            }
            
            if (results.arduino_code) {
                report += `Arduino Code:\n`;
                report += `=============\n`;
                report += results.arduino_code;
            }
            
            return report;
        }

        function showError(message) {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            document.getElementById('designOverview').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error:</strong> ${message}
                </div>
                <p>Please try again with a different description or check the system status.</p>
            `;
        }
    </script>
</body>
</html> 